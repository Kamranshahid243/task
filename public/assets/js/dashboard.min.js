var BASE_URL = $('meta[name="base-url"]').attr('content')
var files = null;
var oldAttachments = null;
var adminList = null;
var activeForm = null;
var searchIndex = null;


$(function(){
    if( $('.select2').length ){
        $('.select2').select2();

        $('.country-list').on('change',function(){

            $('.country-id').val( $(this).val() );
            //$('input[name="languages"]').val(  $(this).val()  );
            var id = $(this).val();
            $.ajax({
                url: BASE_URL + '/get/'+id+'/states',
                method: 'GET',
                success: function ( response ){
                    
                    var options = '<option value="">Select a state</option>';

                    if( response.states.length ){
                        $.each( response.states, function(i, state){
                            options += '<option value="'+state.id+'">'+state.name+'</option>';
                        });
                    }

                    $('.state-list').select2();
                    $('.state-list').html( options  );

                    $('.states-wrapper').removeClass('d-none');

                }
            });
        });


        $('.state-list').on('change',function(){
            //$('input[name="languages"]').val(  $(this).val()  );

            $('.state-id').val( $(this).val() );
            var id = $(this).val();
            $.ajax({
                url: BASE_URL + '/get/'+id+'/cities',
                method: 'GET',
                success: function ( response ){
                    
                    var options = '<option value="">Select a city</option>';

                    if( response.cities.length ){
                        $.each( response.cities, function(i, city){
                            options += '<option value="'+city.id+'">'+city.name+'</option>';
                        });
                    }

                    $('.city-list').select2();
                    $('.city-list').html( options  );

                    $('.cities-wrapper').removeClass('d-none');

                }
            });
        });

        $('.city-list').on('change',function(){
            //$('input[name="languages"]').val(  $(this).val()  );

            $('.city-id').val( $(this).val() );
        });
    }
});




// Datatables
$(function () {

   

    if( $('#data-table').length ){
        $('#data-table').DataTable()

        $( '.dataTable' ).wrap( "<div class='table-responsive'></div>" );
       
    }

    $( '.dataTable' ).wrap( "<div class='table-responsive'></div>" );

    if( $('#result-sheet-table').length ){
       var resultsheetTable =  $('#result-sheet-table').DataTable({
            
            "search": {
                "caseInsensitive": false
            },
            buttons: [
                'excelHtml5'
            ],
            
            'columnDefs': [
                {
                   'targets': 0,
                   'checkboxes': {
                      'selectRow': true
                   }
                }
             ],
             'select': {
                'style': 'multi'
             },
            order: [
                [1, 'asc']
            ]
        });


        // adding searchable fields to the footer of the table
        // var title = '<option value="">Select a table column</option>';
        // $('#result-sheet-table tfoot th').each( function (i, d) {

        //     title += '<option data-index="'+i+'" value="'+$(this).text()+'">Search by '+$(this).text()+'</option>';
        //     if( i != 0 && i != 2 && i < $('#result-sheet-table tfoot th').length-1){
               
                
        //     }
        // } );

        //$('.search-criteria').html( title );

        $('.search-criteria').on('change', function(){
           
            var select        = document.querySelector('.search-criteria').options[ $(this)[0].selectedIndex ];
            var selectedIndex = $(this)[0].selectedIndex;  
            
            if( !selectedIndex ){
                $('.search-word').attr('disabled', 'disabled').removeAttr('placeholder');
                $('.search-word').val(' ');
                $('.col-name').html( '' );
                searchIndex = null;
            }
            else{

                if( searchIndex ){
                     resultsheetTable.column( searchIndex ).search( '' ).draw();
                }
               
                $('.search-word').val('');
                $('.col-name').html( select.value );
                $('.search-word').attr('placeholder', 'Search '+ select.value );
                $('.search-word').removeAttr('disabled');
                searchIndex = select.dataset.index;

               
            }
        });

        $( '.search-word' ).on( 'keyup change', function () {
            
            //var oldContent = $('#result-sheet-table').html();

            if( searchIndex && $(this).val().length){
                //resultsheetTable.column( searchIndex ).search( $(this).val(), [] ).draw();
                //resultsheetTable.column( 9 ).search( 'Publish' ).draw();

                //console.log(searchIndex);

                //console.log( resultsheetTable.column(searchIndex).data().search($(this).val()) );
                var query =     '^' + $(this).val() + '(.*)$';

                resultsheetTable.column(searchIndex).search(query, true, false).draw();
                //resultsheetTable.column(searchIndex).search($(this).val()).draw();
                //resultsheetTable.search($(this).val()).draw();
            }
            else{
                resultsheetTable.column( searchIndex ).search( '' ).draw();
               
            }
           
        });
        // resultsheetTable.columns().eq( 0 ).each( function ( colIdx ) {
        //     $( 'input', resultsheetTable.column( colIdx ).footer() ).on( 'keyup change', function () {
                
        //         var oldContent = $('#result-sheet-table').html();

        //         console.log(colIdx);

        //         if( searchIndex && $(this).val().length){
        //             resultsheetTable.column( searchIndex ).search( $(this).val() ).draw();
        //             //resultsheetTable.column( 8 ).search( 'Male' ).draw();
        //         }
        //         else{
        //             resultsheetTable.column( searchIndex ).search( '' ).draw();
                
        //         }
            
        //     });
        // });



        resultsheetTable.on( 'click', 'th.dt-checkboxes-select-all', function(){
            var checked = $(this).find('input').is(':checked');
            if( checked ){
                $.each( $('.publish-selected'), function( i, btn ){
                    if( $(btn).data('action') == 'unpublish-all' || $(btn).data('action') == 'publish-all' || $(btn).data('action') == 'archieve-all' ){
                        $(btn).show();
                    }
                    else{
                        $(btn).hide();
                    }
                });
            }
            else{
                $('.publish-selected').hide();
            }
        });


       


        resultsheetTable.on( 'click', 'td', function(){
            
            var checked = false;
            
            var checkboxes = $('#result-sheet-table').find('tbody tr .dt-checkboxes');

            $.each( checkboxes, function(i, checkbox){
                if( $( checkbox ).is(':checked') ){
                    checked = true;
                    return false;
                }
            } );
            
            
            if( checked ){
                $.each( $('.publish-selected'), function( i, btn ){
                    if( $(btn).data('action') == 'unpublish-selected' || $(btn).data('action') == 'publish-selected' || $(btn).data('action') == 'archieve-selected' || $(btn).data('action') == 'promote-selected' ){
                        $(btn).show();
                    }
                    else{
                        $(btn).hide();
                    }
                });
            }
            else{
                $('.publish-selected').hide();
            }
        });

        // resultsheetTable.on("click", "th.select-checkbox", function() {
        //     if ($("th.select-checkbox").hasClass("selected")) {
        //         resultsheetTable.rows().deselect();
        //         $('.publish-selected').hide();
        //         $("th.select-checkbox").removeClass("selected");
                
        //     } else {
        //         resultsheetTable.rows().select();
        //         $('.publish-selected').show();
        //         $("th.select-checkbox").addClass("selected");
                
        //     }
        // }).on("select deselect", function() {
        //     //("Some selection or deselection going on")
        //     if (resultsheetTable.rows({
        //             selected: true
        //         }).count() !== resultsheetTable.rows().count()) {
        //         $('.publish-selected').hide();    
        //         $("th.select-checkbox").removeClass("selected");
               
               
        //     } else {
        //         $('.publish-selected').show();
        //         $("th.select-checkbox").addClass("selected");
               
        //     }
            
        // });
    }
    // $('#example2').DataTable({
    //   'paging'      : true,
    //   'lengthChange': false,
    //   'searching'   : false,
    //   'ordering'    : true,
    //   'info'        : true,
    //   'autoWidth'   : false
    // })
})

$(function(){
	$.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });
});

$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})


$(function(){
    if( $('.auc-delete-notification').length > 0){
        $('.auc-delete-notification').on('click', function( e ){
            e.preventDefault();
            var id = $(this).data('target');
            $.ajax({
                url: BASE_URL +'/admin/notifications/'+id,
                method: 'post',
                success: function(response){
                        
                    responseAlert( response.status, response.message );
                    
                    $('.notification-' + id).fadeOut().remove();
        
                },
                error: function(response){
                
                    if( typeof response.responseJSON.errors != 'undefined' ){
                        $.each(response.responseJSON.errors, function(i, field) {
                            responseAlert( 'error', field[0] );
                        })
                    }
                    else if( response.responseJSON.status ){
                        responseAlert( response.responseJSON.status, response.responseJSON.message );
                    } 
                }
            });
        });
    }

});


$(function(){
 
    $('.form').on('submit', function( e ){
        e.preventDefault();

        if( files != null ){
            httpAjaxAttachmentRequest( $(this) );
        }
        else{
            httpAjaxRequest( $(this) );
        }

        
    });

});

$(function(){
    if( $('.auc-login-password-expiry').length > 0 ){
        $.ajax({
            url: BASE_URL + '/security/expiry/check',
            method: 'get',
            success: function( response ){

            },
            error: function( response ){

            }

        });
    }
});

function checkPasswordExpiry(){
    
}


$(function(){
    $('.file-upload-btn').on('click', function(e){
        e.preventDefault();
        
        activeForm = $(this).data('form');
        
        $(this).parents('form').find('.user-picture').trigger('click');
        
    });
});

$(function(){
    if( $('.auc-editor').length > 0 ){
        $('.auc-editor').wysihtml5()
    }
});

$(function(){
    $('.user-picture').on('change', function( e ){
        
        files = $(this).get(0).files;

        var ext = files[0].name.split('.').pop();
        
        if( ext != 'svg' && ext != 'jpg' && ext != 'jpeg' && ext != 'png' && ext != 'gif'){
            files = null;
            responseAlert( 'error', 'Please select a valid image file' );
        }
        else{
            if( activeForm ){
                $(activeForm).submit();
            }
            else{
                 $('.form-with-attachment').submit();
            }
        }
    });
});

$(function(){
    $('.student-picture, .auc-thumbnail').on('change', function( e ){
        
        files = $(this).get(0).files;

        var ext = files[0].name.split('.').pop();
        
        if( ext != 'svg' && ext != 'jpg' && ext != 'jpeg' && ext != 'png' && ext != 'gif'){
            responseAlert( 'error', 'Please upload a valid image file' );
        }

    });
});

$(function(){
 
    $('.content').on('click', '.custom-table-btn', function( e ){
        e.preventDefault();
    

        if( $(this).data('action') == 'edit' || $(this).data('action') == 'view' ){
            
            $('.edit-form').attr('action', BASE_URL+$(this).data('url'));
            getEntityDetail( $(this).data('id'), $(this).data('action'),  $(this).data('url'), $(this).data('type'));
        }
        else if( $(this).data('action') == 'assign_class' ){
            
            $('.class-form').attr('action', BASE_URL+$(this).data('url'));
            getEntityDetail( $(this).data('id'), $(this).data('action'),  $(this).data('url'), $(this).data('type'));
        }
        else if( $(this).data('action') == 'view-message'){
            $('.class-form').attr('action', BASE_URL+$(this).data('url'));
            getEntityDetail( $(this).data('id'), $(this).data('action'),  $(this).data('url'), $(this).data('type'));
        }
        else if( $(this).data('action') == 'delete'){
            $('.delete-form').attr('action', BASE_URL+$(this).data('url'));
            $('.delete-modal').modal('show');
        }
        else if( $(this).data('action') == 'unblock'){
            $('.id').val( $(this).data('id') );
            $('.unblock-form').attr('action', BASE_URL+$(this).data('url'));
            $('.unblock-modal').modal('show');
        }
        else if( $(this).data('action') == 'block'){
            $('.id').val( $(this).data('id') );
            $('.block-form').attr('action', BASE_URL+$(this).data('url'));
            $('.block-modal').modal('show');
        }
        else if( $(this).data('action') == 'approve'){
            $('.id').val( $(this).data('id') );
            $('.approve-form').attr('action', BASE_URL+$(this).data('url'));
            $('.approve-modal').modal('show');
        }
        else if( $(this).data('action') == 'disapprove'){
            $('.id').val( $(this).data('id') );
            $('.disapprove-form').attr('action', BASE_URL+$(this).data('url'));
            $('.disapprove-modal').modal('show');
        }
        else if( $(this).data('action') == 'open'){
            $('.id').val( $(this).data('id') );
            $('.open-form').attr('action', BASE_URL+$(this).data('url'));
            $('.open-modal').modal('show');
        }
        else if( $(this).data('action') == 'close'){
            $('.id').val( $(this).data('id') );
            $('.close-form').attr('action', BASE_URL+$(this).data('url'));
            $('.close-modal').modal('show');
        }
        else if( $(this).data('action') == 'hide'){
            $('.id').val( $(this).data('id') );
            $('.hide-post-form').attr('action', BASE_URL+$(this).data('url'));
            $('.hide-post-modal').modal('show');
        }
        else if( $(this).data('action') == 'show'){
            $('.id').val( $(this).data('id') );
            $('.show-post-form').attr('action', BASE_URL+$(this).data('url'));
            $('.show-post-modal').modal('show');
        }
        else if( $(this).data('action') == 'unpublish'){
            $('.id').val( $(this).data('id') );
            $('.unpublish-form').attr('action', BASE_URL+$(this).data('url'));
            $('.unpublish-modal').modal('show');
        }
        else if( $(this).data('action') == 'publish'){
            $('.id').val( $(this).data('id') );
            $('.publish-form').attr('action', BASE_URL+$(this).data('url'));
            $('.publish-modal').modal('show');
        }
        else if( $(this).data('action') == 'archeive'){
           
            $('.archeive-form').attr('action', BASE_URL+$(this).data('url'));
            $('.archeive-modal').modal('show');
        }
        else if( $(this).data('action') == 'promote'){
           
            $('.promote-form').attr('action', BASE_URL+$(this).data('url'));
            $('.promote-modal').modal('show');
        }
        else if( $(this).data('action') == 'unpublish-all'){
           
            var ids = '';

            $.each($('.selected'), function(i, row){

                if( typeof $(row).data('id') != 'undefined' ){
                    if( ids.length == 0 ){
                        ids += $(row).data('id');
                    }
                    else{
                        ids += ','+$(row).data('id');
                    }
                }
            });

            $('.unpublish-all').val(ids);
            $('.unpublish-all-form').attr('action', BASE_URL+$(this).data('url'));
            $('.unpublish-all-modal').modal('show');
        }
        else if( $(this).data('action') == 'unpublish-selected'){
           
            var ids = '';
            var terms = '';
            $.each($('.selected'), function(i, row){

                if( typeof $(row).data('id') != 'undefined' ){
                    if( ids.length == 0 ){
                        ids += $(row).data('id');

                        if( $(row).data('term-id') ){
                            terms += $(row).data('term-id');
                        }
                        else{
                            terms += '-1';
                        }
                    }
                    else{
                        ids += ','+$(row).data('id');

                        if( $(row).data('term-id') ){
                            terms += ','+$(row).data('term-id');
                        }
                        else{
                            terms += ',-1';
                        }
                    }
                }
            });

            $('.unpublish-selected').val(ids);
            $('.terms-unpublish-selected').val(terms);
            $('.unpublish-selected-form').attr('action', BASE_URL+$(this).data('url'));
            $('.unpublish-selected-modal').modal('show');
        }
        else if( $(this).data('action') == 'publish-all'){

            var ids = '';
            $.each($('.selected'), function(i, row){
                if( typeof $(row).data('id') != 'undefined' ){
                    if( ids.length == 0 ){
                        ids += $(row).data('id');
                    }
                    else{
                        ids += ','+$(row).data('id');
                    }
                    
                }
            });
            $('.publish-all').val(ids);
            $('.publish-all-form').attr('action', BASE_URL+$(this).data('url'));
            $('.publish-all-modal').modal('show');
        }
        else if( $(this).data('action') == 'publish-selected'){

            var ids = '';
            var terms = '';
            $.each($('.selected'), function(i, row){
                if( typeof $(row).data('id') != 'undefined' ){
                    if( ids.length == 0 ){
                        ids += $(row).data('id');
                        if( $(row).data('term-id') ){
                            terms += $(row).data('term-id');
                        }
                        else{
                            terms += '-1';
                        }
                    }
                    else{
                        ids += ','+$(row).data('id');
                        
                        if( $(row).data('term-id') ){
                            terms += ',' + $(row).data('term-id');
                        }
                        else{
                            terms += ',-1';
                        }
                    }
                    
                }
            });
            $('.publish-selected').val(ids);
            $('.terms-publish-selected').val(terms);
            $('.publish-selected-form').attr('action', BASE_URL+$(this).data('url'));
            $('.publish-selected-modal').modal('show');
        }
        else if( $(this).data('action') == 'archieve-all'){

            var ids = '';

            $.each($('.selected'), function(i, row){
                if( typeof $(row).data('id') != 'undefined' ){
                    if( ids.length == 0 ){
                        ids += $(row).data('id');
                    }
                    else{
                        ids += ','+$(row).data('id');
                    }
                    
                }
            });
            $('.archeive-all').val(ids);
            $('.archieve-all-form').attr('action', BASE_URL+$(this).data('url'));
            $('.archieve-all-modal').modal('show');
        }
        else if( $(this).data('action') == 'archieve-selected'){

            var ids = '';
            var terms = '';

            $.each($('.selected'), function(i, row){
                if( typeof $(row).data('id') != 'undefined' ){
                    if( ids.length == 0 ){
                        ids += $(row).data('id');
                        
                        if( $(row).data('term-id') ){
                            terms += $(row).data('term-id');
                        }
                        else{ 
                            terms += '-1';
                        }
                    }
                    else{
                        ids += ','+$(row).data('id');
                        
                        if( $(row).data('term-id') ){
                            terms += ','+$(row).data('term-id');
                        }
                        else{
                            terms += ',-1';
                        }
                    }
                }
            });
            $('.archeive-selected').val(ids);
            $('.terms-archeive-selected').val(terms);
            $('.archieve-selected-form').attr('action', BASE_URL+$(this).data('url'));
            $('.archieve-selected-modal').modal('show');
        }
        else if( $(this).data('action') == 'promote-selected'){

            var ids = '';

            $.each($('.selected'), function(i, row){
                if( typeof $(row).data('id') != 'undefined' ){
                    if( ids.length == 0 ){
                        ids += $(row).data('student-id');
                    }
                    else{
                        ids += ','+$(row).data('id');
                    }
                    
                }
            });
            $('.promote-selected').val(ids);
            $('.promote-selected-form').attr('action', BASE_URL+$(this).data('url'));
            $('.promote-selected-modal').modal('show');
        }
    });

});


$(function(){
 
    $('.form-with-attachment').on('submit', function( e ){
        e.preventDefault();

        
        httpAjaxAttachmentRequest( $(this) );
    });

});

function initProgressBar( $form ){


    var dom  = '<div class="progress sm">';
        dom += '<div class="progress-bar progress-bar-animated progress-bar-green" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>';
        dom += '</div>';
    
    $form.find('.progress-bar-wrapper').html( dom );

}

function removeProgressBar( $form ){
    $form.find('.progress-bar-wrapper').html('');
}

function httpAjaxAttachmentRequest( $form ){
    
    var error = false;
    var formData = new FormData();
  
    if( !files &&  $form.hasClass('optional-attachment') ){
        httpAjaxRequest( $form );
    }
    if(  files && files.length ){
       
        var ext = files[0].name.split('.').pop();
        
        if( ext != 'svg' && ext != 'jpg' && ext != 'jpeg' && ext != 'png' && ext != 'gif'){
            responseAlert( 'error', 'Please upload a valid image file' );
        }
        else{
            $.each(files, function(i, file){
                formData.append('attachments-'+i, file); 
            });

            //console.log();
            if( $('#editor').length ){
                formData.append('content', tinyMCE.activeEditor.getBody().innerHTML);
            }
            else{
                
           
                    
                $.each($form.serializeArray(),  function(index, field){
                    if( field.name != 'student_picture' ){
                        formData.append( field.name, field.value );
                    }
                });
            
        
                
                $.ajax({
                    url: $form.attr('action'),
                    method: $form.attr('method'),
                    data: formData,
                    xhr: function(){
                        var xhr = null; 
                        if (window.XMLHttpRequest) {
                            // code for modern browsers
                            xhr = new XMLHttpRequest();
                        } else {
                            // code for old IE browsers
                            xhr = new ActiveXObject("Microsoft.XMLHTTP");
                        }
            
                        if( files != null && files.length ){
            
                            initProgressBar( $form );
            
                            var percentage = 0;
                            
                            xhr.upload.addEventListener('progress', function(event){
                                percentage = Math.round((event.loaded/event.total)*100);
            
                                $('.progress > .progress-bar').css('width', percentage+'%');
                                $('.progress > .progress-bar').html();
            
                                if( percentage >= 100 ){
            
                                    setTimeout(function(){
                                        removeProgressBar( $form );
                                    }, 5000);
            
                                }
                            });
          
                        }
                        return xhr;
                    },
                    success: function(response){
                        
                        responseAlert( response.status, response.message );
                        
                        if( response.refresh ){
                            setTimeout(function(){
                                window.location.reload();
                            }, 2000);
                        }
            
                    },
                    error: function(response){
                    
                        if( typeof response.responseJSON.errors != 'undefined' ){
                            $.each(response.responseJSON.errors, function(i, field) {
                                responseAlert( 'error', field[0] );
                            })
                        }
                        else if( response.responseJSON.status ){
                            responseAlert( response.responseJSON.status, response.responseJSON.message );
                        } 
                    },
                    contentType: false,
                    cache: false,
                    processData: false	
                });	
   
            }
        } 
    }
    else{
        responseAlert( 'error', 'The picture is missing' );
    } 
}


function httpAjaxRequest( $form ){ 

 
    var btnContent = $form.find('.form-btn').html();
    $form.find('.form-btn').html('Processing...');
   
    if($('#editor2').length ){
            for ( instance in CKEDITOR.instances )
                    CKEDITOR.instances[instance].updateElement();
    }

    var formData = new FormData();

    $.each( $form.serializeArray(), function( i, input){
        if( input.name != 'thumbnail' ){
           
            formData.append( input.name, input.value );
        }
    })


    $.ajax({
        url: $form.attr('action'),
        method: $form.attr('method'),
        data: formData,
        success: function( response ){

            if( !$form.hasClass('create-messageboard') ){
                //$('.form')[0].reset();
            }
            

            $form.find('.form-btn').html( btnContent );
            responseAlert( response.status, response.message );

            if( response.loggedIn ){
                window.location.reload();
            }
            else if( response.redirect ){
                setTimeout(function(){
                    window.location = response.redirect;
                }, 2000);
            }

            if( response.url ){
                setTimeout(function(){
                    //window.location.reload();
                    window.location = response.url;
               }, 2000);
            }    

            if( response.refresh ){
                setTimeout(function(){
                    // window.location = response.url;
                    window.location.reload();
                }, 2000);
               
            }
        },
        error: function( response ){
            
          if(response.responseJSON.errors  ){
                $.each(response.responseJSON.errors, function(i, field) {
                    responseAlert( 'error', field[0] );
                    return false;
                })
           }
           else if( response.responseJSON.status ){
                responseAlert( response.responseJSON.status, response.responseJSON.message );
           }
           
           if( response.redirect ){
                setTimeout(function(){
                    window.location = response.redirect;
                }, 2000);
           }


            $form.find('.form-btn').html( btnContent );
        },
        contentType: false,
        cache: false,
        processData: false	

        
    });

}


function validationErrors( $form ){
    
    var error = '';

    $.each($form.serializeArray(), function(i, field) {
        console.log(field)
    });
}


function responseAlert( status, message ){
    
    var title = '';

    if( status == 'success' ){
        title = 'Success!';
    }
    else if( status == 'error' ){
        title = 'Error!';
    }
    else if( status == 'warning' ){
        title = 'Warning!';
    }
    else if( status == 'info' ){
        title = 'Info!';
    }

    Swal.fire({         
        title: title,
        background: '#2a3542',
        text: message,
        type: status,
        timer: 6000,
        showConfirmButton:false,
        toast:true,
        position:'top-end',
        customClass: 'popup-alert'
    
    });
}